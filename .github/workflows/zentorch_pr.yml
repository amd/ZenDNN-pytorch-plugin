name: ZenDNN PyTorch Plugin CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      zendnn_ref:
        description: 'ZenDNN branch or PR ref (e.g. refs/pull/123/head)'
        required: false
        default: ''
      zentorch_use_local_zendnn:
        description: 'Set to 1 to use local ZenDNN'
        required: false
        default: '1'
      zentorch_use_local_blis:
        description: 'Set to 1 to use local BLIS'
        required: false
        default: '1'
  repository_dispatch:
    types: [zendnn-pr]

jobs:
  build:
    runs-on: [amd-zenai-arc-xlarge-dind]

    env:
      PYTHON_VERSION: '3.10'
      ZENTORCH_VERSION: '5.2.0'
      NATIVE_TORCH_VERSION: '2.8.0'
      UNWANTED_KEYWORDS: 'stackoverflow,MSDN,wiki,microsoft'
      ZENTORCH_USE_LOCAL_ZENDNN: ${{ github.event.inputs.zentorch_use_local_zendnn || github.event.client_payload.zentorch_use_local_zendnn || '1' }}
      ZENTORCH_USE_LOCAL_BLIS: ${{ github.event.inputs.zentorch_use_local_blis || github.event.client_payload.zentorch_use_local_blis || '1' }}
      BLIS_TAR_BALL: 'AOCL-Sep2025-b1.tar.gz'
      ZENDNN_REF: ${{ github.event.inputs.zendnn_ref || github.event.client_payload.zendnn_ref || '' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Define workspace layout
        shell: bash
        run: |
            set -euo pipefail
            WORKSPACE_PARENT="$(dirname "$GITHUB_WORKSPACE")"
            echo "WORKSPACE=$WORKSPACE_PARENT" >> "$GITHUB_ENV"
            echo "PARENT_DIR=$WORKSPACE_PARENT" >> "$GITHUB_ENV"
            echo "WORKSPACE_ROOT=$GITHUB_WORKSPACE" >> "$GITHUB_ENV"
            echo "REPO_NAME=$(basename "$GITHUB_WORKSPACE")" >> "$GITHUB_ENV"
            echo "Planned directory structure:"
            echo "$WORKSPACE_PARENT/"
            echo "  $(basename "$GITHUB_WORKSPACE") (repo)"
            echo "  ZenDNN_tools"
            echo "  ZenDNN"
            echo "  blis"
            echo "  \$BLIS_TAR_BALL"

      - name: Setup isolated global git config (no HOME mutation)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p /tmp/git-config
          touch /tmp/git-config/gitconfig
          chmod 600 /tmp/git-config/gitconfig
          echo "GIT_CONFIG_GLOBAL=/tmp/git-config/gitconfig" >> "$GITHUB_ENV"
          echo "Configured isolated global git config at /tmp/git-config/gitconfig"

      - name: Initialize git configuration
        shell: bash
        run: |
          set -euo pipefail
          git config --global init.defaultBranch main
          # Mark current repo safe
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          # Pre-add expected sibling paths (created later) to avoid future safe.directory warnings
          git config --global --add safe.directory "$(dirname "$GITHUB_WORKSPACE")/ZenDNN_tools" || true
          git config --global --add safe.directory "$(dirname "$GITHUB_WORKSPACE")/ZenDNN" || true
          echo "Global git config:"
          git config --global --list || true

      - name: Prepare clean slate in workspace parent
        shell: bash
        run: |
          set -euo pipefail
          echo "Workspace parent: $WORKSPACE"
          for item in ZenDNN ZenDNN_tools blis "$BLIS_TAR_BALL"; do
            if [ -e "$WORKSPACE/$item" ]; then
              echo "Removing stale $item"
              rm -rf "$WORKSPACE/$item"
            fi
          done
          echo "Current contents:"
          ls -1 "$WORKSPACE" || true

      - name: Clone ZenDNN_tools (sibling directory)
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${{ secrets.ZIAIE_PAT }}" ]; then
            echo "ERROR: Missing secret ZIAIE_PAT"
            exit 1
          fi
          git clone --depth 1 --branch main https://${{ secrets.ZIAIE_PAT }}@github.com/AMD-Zenai/ZenDNN_tools.git "$WORKSPACE/ZenDNN_tools"
          git config --global --add safe.directory "$WORKSPACE/ZenDNN_tools" || true
          mkdir -p "$WORKSPACE/ZenDNN_tools/scripts/ci"
          for s in zendnn_ci_pt_plugin_presub_build.sh zendnn_ci_PT_PLUGIN_build.sh; do
            if [ -f "$WORKSPACE/ZenDNN_tools/$s" ]; then
              cp "$WORKSPACE/ZenDNN_tools/$s" "$WORKSPACE/ZenDNN_tools/scripts/ci/"
            fi
          done
          chmod +x "$WORKSPACE/ZenDNN_tools"/*.sh || true
          chmod +x "$WORKSPACE/ZenDNN_tools/scripts/ci/"*.sh || true
          echo "ZenDNN_tools CI scripts:"
            ls -1 "$WORKSPACE/ZenDNN_tools/scripts/ci" || true

      - name: Run presub build
        shell: bash
        env:
          WORKSPACE: ${{ env.WORKSPACE }}
          WORKSPACE_ROOT: ${{ env.WORKSPACE_ROOT }}
          PYTHON_VERSION: ${{ env.PYTHON_VERSION }}
          BUILD_PYTHON_VERSIONS: ${{ env.PYTHON_VERSION }}
          ZENTORCH_VERSION: ${{ env.ZENTORCH_VERSION }}
          NATIVE_TORCH_VERSION: ${{ env.NATIVE_TORCH_VERSION }}
          ZENTORCH_USE_LOCAL_ZENDNN: ${{ env.ZENTORCH_USE_LOCAL_ZENDNN }}
          ZENTORCH_USE_LOCAL_BLIS: ${{ env.ZENTORCH_USE_LOCAL_BLIS }}
          UNWANTED_KEYWORDS: ${{ env.UNWANTED_KEYWORDS }}
          BLIS_TAR_BALL: ${{ env.BLIS_TAR_BALL }}
          ZENDNN_REF: ${{ env.ZENDNN_REF }}
        run: |
          set -euo pipefail
          script_dir="$WORKSPACE/ZenDNN_tools/scripts/ci"
          presub="$script_dir/zendnn_ci_pt_plugin_presub_build.sh"
          plugin="$script_dir/zendnn_ci_PT_PLUGIN_build.sh"

          if [ ! -f "$presub" ]; then
            echo "ERROR: Presub script missing at $presub"
            ls -R "$WORKSPACE/ZenDNN_tools" || true
            exit 1
          fi

          # Minimal safe adjustments
          sed -i 's/\bsudo\b//g' "$presub" || true
          if [ -f "$plugin" ]; then
            sed -i 's|/root/anaconda3/|/proj/zendai_conda/miniforge3/|g' "$plugin" || true
            sed -i 's/\bsudo\b//g' "$plugin" || true
          fi

          echo "Workspace contents before build:"
          ls -1 "$WORKSPACE" || true

          cd "$script_dir"
          set -x
          bash "$(basename "$presub")"

      - name: Archive wheel artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zentorch-wheels
          path: |
            ${{ env.WORKSPACE }}/ZenDNN_PyTorch_Plugin/dist/*.whl

      - name: Cleanup workspace (remove all created dirs)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          echo "Cleaning workspace: $WORKSPACE"
          ls -1 "$WORKSPACE" || true
          rm -rf "$WORKSPACE/ZenDNN_PyTorch_Plugin" \
                 "$WORKSPACE/ZenDNN_tools" \
                 "$WORKSPACE/ZenDNN" \
                 "$WORKSPACE/blis" \
                 "$WORKSPACE/$BLIS_TAR_BALL" || true
          echo "Remaining (should be empty or system dirs):"
          ls -1 "$WORKSPACE" || true
