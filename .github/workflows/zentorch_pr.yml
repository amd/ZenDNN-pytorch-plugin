name: ZenDNN PyTorch Plugin CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      zendnn_ref:
        description: 'ZenDNN branch or PR ref (optional, e.g. refs/pull/123/head)'
        required: false
        default: ''
      zentorch_use_local_zendnn:
        description: 'Set to 1 to use local ZenDNN'
        required: false
        default: '1'
      zentorch_use_local_blis:
        description: 'Set to 1 to use local BLIS'
        required: false
        default: '1'
  repository_dispatch:
    types: [zendnn-pr]

jobs:
  build:
    runs-on: [amd-zenai-arc-xlarge-dind]

    env:
      PYTHON_VERSION: '3.10'
      ZENTORCH_VERSION: '5.2.0'
      NATIVE_TORCH_VERSION: '2.8.0'
      UNWANTED_KEYWORDS: 'stackoverflow,MSDN,wiki,microsoft'
      ZENTORCH_USE_LOCAL_ZENDNN: ${{ github.event.inputs.zentorch_use_local_zendnn || github.event.client_payload.zentorch_use_local_zendnn || '1' }}
      ZENTORCH_USE_LOCAL_BLIS: ${{ github.event.inputs.zentorch_use_local_blis || github.event.client_payload.zentorch_use_local_blis || '1' }}
      BLIS_TAR_BALL: 'AOCL-Sep2025-b1.tar.gz'
      ZENDNN_REF: ${{ github.event.inputs.zendnn_ref || github.event.client_payload.zendnn_ref || '' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
            fetch-depth: 1

      - name: Setup working directories (WORKSPACE = parent, repo root preserved)
        shell: bash
        run: |
          set -euo pipefail
          ORIGINAL_HOME=$HOME
          echo "ORIGINAL_HOME=$ORIGINAL_HOME" >> "$GITHUB_ENV"

          WORKSPACE_ROOT="$GITHUB_WORKSPACE"
          echo "WORKSPACE_ROOT=$WORKSPACE_ROOT" >> "$GITHUB_ENV"

          PARENT_DIR="$(dirname "$WORKSPACE_ROOT")"
          echo "PARENT_DIR=$PARENT_DIR" >> "$GITHUB_ENV"

          WORKSPACE="$PARENT_DIR"
          export WORKSPACE
          echo "WORKSPACE=$WORKSPACE" >> "$GITHUB_ENV"

          REPO_NAME="$(basename "$WORKSPACE_ROOT")"
          echo "REPO_NAME=$REPO_NAME" >> "$GITHUB_ENV"

          echo "EXPECTED_REPO_DIR=$WORKSPACE_ROOT" >> "$GITHUB_ENV"

          GIT_CONFIG_DIR="/tmp/git-home-$$"
          mkdir -p "${GIT_CONFIG_DIR}"
          chmod 700 "${GIT_CONFIG_DIR}"
          echo "GIT_CONFIG_DIR=${GIT_CONFIG_DIR}" >> "$GITHUB_ENV"

          echo "Cleaning up stale build-related directories in repo root..."
          pushd "$WORKSPACE_ROOT" >/dev/null
          for item in ZenDNN ZenDNN_tools blis "${BLIS_TAR_BALL}"; do
            if [ -e "$item" ]; then
              echo "Removing existing $item"
              rm -rf "$item"
            fi
          done
          popd >/dev/null

          echo "--- Debug Path Context ---"
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          echo "WORKSPACE_ROOT=$WORKSPACE_ROOT"
          echo "WORKSPACE (parent)=$WORKSPACE"
          echo "REPO_NAME=$REPO_NAME"
          echo "Parent directory listing:"
          ls -1 "$WORKSPACE" || true
          echo "--------------------------"

      - name: Initialize Git Configuration
        shell: bash
        env:
          GIT_CONFIG_GLOBAL: "${{ env.GIT_CONFIG_DIR }}/gitconfig"
        run: |
          set -euo pipefail
          export GIT_CONFIG_GLOBAL
          git config --global init.defaultBranch main
          git config --global --add safe.directory "*"
          git config --list || true

      - name: Clone and verify ZenDNN_tools
        shell: bash
        run: |
          set -euo pipefail
          cd "$WORKSPACE_ROOT"

          if [ -d "ZenDNN_tools" ]; then
            echo "Removing existing ZenDNN_tools"
            rm -rf ZenDNN_tools
          fi

          if [ -z "${{ secrets.ZIAIE_PAT }}" ]; then
            echo "ERROR: Missing secret ZIAIE_PAT"
            exit 1
          fi

          echo "Cloning ZenDNN_tools into repo root..."
          git clone --depth 1 --branch main https://${{ secrets.ZIAIE_PAT }}@github.com/AMD-Zenai/ZenDNN_tools.git ZenDNN_tools

          test -d ZenDNN_tools || { echo "Clone failed"; exit 1; }

          mkdir -p ZenDNN_tools/scripts/ci
          for script in zendnn_ci_pt_plugin_presub_build.sh zendnn_ci_PT_PLUGIN_build.sh; do
            if [ -f "ZenDNN_tools/$script" ]; then
              cp "ZenDNN_tools/$script" "ZenDNN_tools/scripts/ci/"
            else
              echo "WARN: $script missing in root of ZenDNN_tools"
            fi
          done

          chmod +x ZenDNN_tools/scripts/ci/*.sh || true
          chmod +x ZenDNN_tools/*.sh || true

          # Provide parent-level fallback for scripts that expect $WORKSPACE/ZenDNN_tools
          if [ ! -e "$WORKSPACE/ZenDNN_tools" ]; then
            echo "Creating parent-level symlink: $WORKSPACE/ZenDNN_tools -> $WORKSPACE_ROOT/ZenDNN_tools"
            ln -s "$WORKSPACE_ROOT/ZenDNN_tools" "$WORKSPACE/ZenDNN_tools"
          fi

          echo "Listing CI scripts:"
          ls -la ZenDNN_tools/scripts/ci
          echo "Parent symlink check:"
          ls -ld "$WORKSPACE/ZenDNN_tools" || true

      - name: Run CI script
        shell: bash
        env:
          PYTHON_VERSION: ${{ env.PYTHON_VERSION }}
          WORKSPACE: ${{ env.WORKSPACE }}            # parent
          WORKSPACE_ROOT: ${{ env.WORKSPACE_ROOT }}  # repo root
          BUILD_PYTHON_VERSIONS: ${{ env.PYTHON_VERSION }}
          ZENTORCH_VERSION: ${{ env.ZENTORCH_VERSION }}
          NATIVE_TORCH_VERSION: ${{ env.NATIVE_TORCH_VERSION }}
          ZENTORCH_USE_LOCAL_ZENDNN: ${{ env.ZENTORCH_USE_LOCAL_ZENDNN }}
          ZENTORCH_USE_LOCAL_BLIS: ${{ env.ZENTORCH_USE_LOCAL_BLIS }}
          UNWANTED_KEYWORDS: ${{ env.UNWANTED_KEYWORDS }}
          BLIS_TAR_BALL: ${{ env.BLIS_TAR_BALL }}
          GIT_CONFIG_GLOBAL: ${{ env.GIT_CONFIG_DIR }}/gitconfig
        run: |
          set -euo pipefail
          echo "--- Runtime Environment Check ---"
          echo "WORKSPACE(parent): $WORKSPACE"
          echo "WORKSPACE_ROOT(repo): $WORKSPACE_ROOT"
          echo "Expect plugin scripts under:"
          echo " - $WORKSPACE_ROOT/ZenDNN_tools/scripts/ci"
          echo " - $WORKSPACE/ZenDNN_tools/scripts/ci (fallback via symlink)"
          ls -1 "$WORKSPACE_ROOT/ZenDNN_tools/scripts/ci" || true
          ls -1 "$WORKSPACE/ZenDNN_tools/scripts/ci" || true
          echo "---------------------------------"

          script_path="$WORKSPACE_ROOT/ZenDNN_tools/scripts/ci/zendnn_ci_pt_plugin_presub_build.sh"
          plugin_script_path="$WORKSPACE_ROOT/ZenDNN_tools/scripts/ci/zendnn_ci_PT_PLUGIN_build.sh"

          if [ ! -f "$script_path" ] && [ -f "$WORKSPACE_ROOT/ZenDNN_tools/zendnn_ci_pt_plugin_presub_build.sh" ]; then
            echo "Fallback: using presub script from ZenDNN_tools root"
            script_path="$WORKSPACE_ROOT/ZenDNN_tools/zendnn_ci_pt_plugin_presub_build.sh"
            sed -i "s|source \$WORKSPACE/ZenDNN_tools/scripts/ci/zendnn_ci_PT_PLUGIN_build.sh|source \$WORKSPACE/ZenDNN_tools/zendnn_ci_PT_PLUGIN_build.sh|g" "$script_path"
          fi

          # Harden path usage inside script: ensure references include repo folder when needed
          # (The inconsistent original usage caused earlier path issues)
          sed -i "s|\$WORKSPACE/ZenDNN_tools|\$WORKSPACE/$(basename "$WORKSPACE_ROOT")/ZenDNN_tools|g" "$script_path" || true
          # But also keep a defensive symlink so either form works:
          if [ ! -e "$WORKSPACE/ZenDNN_tools" ]; then
            ln -s "$WORKSPACE_ROOT/ZenDNN_tools" "$WORKSPACE/ZenDNN_tools"
          fi

          cp "$script_path" "${script_path}.backup"

          sed -i 's/\bsudo\b//g' "$script_path"
          sed -i '/mkmhub/ s@mkmhub@-v /proj/zendai:/proj/zendai -v /home/runner:/home/runner mkmhub@' "$script_path"
          sed -i '/git config --global --add/ s/^/# /' "$script_path"
          sed -i 's|torch-\$NATIVE_TORCH_VERSION|torch-$NATIVE_TORCH_VERSION-xco|g' "$script_path"

          if [ -f "$plugin_script_path" ]; then
            sed -i 's|/root/anaconda3/|/proj/zendai_conda/miniforge3/|g' "$plugin_script_path"
            sed -i 's/^\(conda init bash\|conda config --set auto_activate_base false\|source ~\/.bashrc\)/# \1/' "$plugin_script_path"
          else
            echo "WARN: Missing plugin script at $plugin_script_path"
            # Try alternate location via parent symlink (in case patching changed usage)
            alt_plugin="$WORKSPACE/ZenDNN_tools/scripts/ci/zendnn_ci_PT_PLUGIN_build.sh"
            if [ -f "$alt_plugin" ]; then
              echo "Found alternate plugin script at $alt_plugin"
              plugin_script_path="$alt_plugin"
            fi
          fi

          # Ensure we run from the directory containing presub script
          cd "$(dirname "$script_path")"
          echo "Executing build script: $script_path"
          echo "PWD: $(pwd)"
          set -x
          bash "$(basename "$script_path")"

      - name: Archive build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zentorch-artifacts
          path: |
            ${{ env.WORKSPACE_ROOT }}/ZenDNN_PyTorch_Plugin/dist/*.whl

      - name: Cleanup workspace (safe)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p /tmp/zentorch_artifacts
          cp -f "${WORKSPACE_ROOT}"/*.whl /tmp/zentorch_artifacts/ 2>/dev/null || true
          rm -rf "${WORKSPACE_ROOT}/ZenDNN" \
                 "${WORKSPACE_ROOT}/ZenDNN_tools" \
                 "${WORKSPACE_ROOT}/blis" \
                 "${WORKSPACE_ROOT}/${BLIS_TAR_BALL}" || true
          echo "Cleanup complete (HOME preserved)."
