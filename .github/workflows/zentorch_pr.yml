name: ZenDNN PyTorch Plugin CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      zendnn_ref:
        description: 'ZenDNN branch or PR ref (optional, e.g. refs/pull/123/head)'
        required: false
        default: ''
      zentorch_use_local_zendnn:
        description: 'Set to 1 to use local ZenDNN'
        required: false
        default: '1'
      zentorch_use_local_blis:
        description: 'Set to 1 to use local BLIS'
        required: false
        default: '1'
  repository_dispatch:
    types: [zendnn-pr]

jobs:
  build:
    runs-on: [amd-zenai-arc-xlarge-dind]
    env:
      PYTHON_VERSION: '3.10'
      ZENTORCH_VERSION: '5.2.0'
      NATIVE_TORCH_VERSION: '2.8.0'
      UNWANTED_KEYWORDS: 'stackoverflow,MSDN,wiki,microsoft'
      ZENTORCH_USE_LOCAL_ZENDNN: ${{ github.event.inputs.zentorch_use_local_zendnn || github.event.client_payload.zentorch_use_local_zendnn || '1' }}
      ZENTORCH_USE_LOCAL_BLIS: ${{ github.event.inputs.zentorch_use_local_blis || github.event.client_payload.zentorch_use_local_blis || '1' }}
      BLIS_TAR_BALL: 'AOCL-Sep2025-b1.tar.gz'
      ZENDNN_REF: ${{ github.event.inputs.zendnn_ref || github.event.client_payload.zendnn_ref || '' }}

    steps:
      - name: Setup working directories
        run: |
          # Create a temporary home directory with proper permissions
          export HOME="/tmp/git-home-$$"
          mkdir -p "${HOME}"
          chmod 700 "${HOME}"
          echo "HOME=${HOME}" >> $GITHUB_ENV
          
          # Setup workspace root
          WORKSPACE_ROOT="$GITHUB_WORKSPACE"
          echo "WORKSPACE_ROOT=$WORKSPACE_ROOT" >> $GITHUB_ENV
          
          # Clean up all existing directories and files
          echo "Cleaning up existing directories and files..."
          for item in \
            "ZenDNN" \
            "ZenDNN_tools" \
            "blis" \
            "ZenDNN_PyTorch_Plugin" \
            "$BLIS_TAR_BALL"
          do
            if [ -e "$WORKSPACE_ROOT/$item" ]; then
              echo "Removing existing $item"
              rm -rf "$WORKSPACE_ROOT/$item"
            fi
          done
          
          # Set consistent directory variables
          echo "PARENT_DIR=$WORKSPACE_ROOT" >> $GITHUB_ENV
          echo "WORKSPACE=$WORKSPACE_ROOT" >> $GITHUB_ENV
        shell: bash

      - name: Checkout ZenDNN_PyTorch_Plugin
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clone ZenDNN if needed
        if: env.ZENTORCH_USE_LOCAL_ZENDNN == '1'
        run: |
          if [ -d "$WORKSPACE_ROOT/ZenDNN" ]; then
            echo "Removing existing ZenDNN directory"
            rm -rf "$WORKSPACE_ROOT/ZenDNN"
          fi
          
          git clone --depth 1 --branch main https://${{ secrets.ZIAIE_PAT }}@github.com/AMD-Zenai/ZenDNN.git "$WORKSPACE_ROOT/ZenDNN"
          
          if [ ! -d "$WORKSPACE_ROOT/ZenDNN" ]; then
            echo "Error: ZenDNN directory not created"
            exit 1
          fi
          
          if [ "${ZENDNN_REF}" != "" ]; then
            cd "$WORKSPACE_ROOT/ZenDNN"
            git fetch origin "${ZENDNN_REF}"
            git checkout FETCH_HEAD
          fi
        shell: bash

      - name: Copy and extract BLIS tarball if needed
        if: env.ZENTORCH_USE_LOCAL_BLIS == '1'
        run: |
          # Remove existing BLIS directory and tarball if they exist
          if [ -d "$WORKSPACE_ROOT/blis" ]; then
            echo "Removing existing blis directory"
            rm -rf "$WORKSPACE_ROOT/blis"
          fi
          if [ -f "$WORKSPACE_ROOT/$BLIS_TAR_BALL" ]; then
            echo "Removing existing BLIS tarball"
            rm -f "$WORKSPACE_ROOT/$BLIS_TAR_BALL"
          fi
          
          # Copy and extract new BLIS tarball
          echo "Copying BLIS tarball..."
          cp /proj/zendai/datasets/ci_zendnn_presub_dependencies/$BLIS_TAR_BALL "$WORKSPACE_ROOT/"
          
          if [ ! -f "$WORKSPACE_ROOT/$BLIS_TAR_BALL" ]; then
            echo "Error: Failed to copy BLIS tarball"
            exit 1
          fi
          
          echo "Extracting BLIS tarball..."
          tar -xzf "$WORKSPACE_ROOT/$BLIS_TAR_BALL" -C "$WORKSPACE_ROOT/"
          
          if [ ! -d "$WORKSPACE_ROOT/blis" ]; then
            echo "Error: BLIS directory not created after extraction"
            exit 1
          fi
        shell: bash

      - name: Clone and verify ZenDNN_tools
        run: |
          # Remove existing ZenDNN_tools directory if it exists
          if [ -d "$WORKSPACE_ROOT/ZenDNN_tools" ]; then
            echo "Removing existing ZenDNN_tools directory"
            rm -rf "$WORKSPACE_ROOT/ZenDNN_tools"
          fi
          
          # Clone ZenDNN_tools
          echo "Cloning ZenDNN_tools..."
          git clone --depth 1 --branch main https://${{ secrets.ZIAIE_PAT }}@github.com/AMD-Zenai/ZenDNN_tools.git "$WORKSPACE_ROOT/ZenDNN_tools"
          
          # Verify the clone and required files
          if [ ! -d "$WORKSPACE_ROOT/ZenDNN_tools" ]; then
            echo "Error: ZenDNN_tools directory not created"
            exit 1
          fi
          
          # Verify script files exist
          required_scripts=(
            "zendnn_ci_pt_plugin_presub_build.sh"
            "zendnn_ci_PT_PLUGIN_build.sh"
          )
          
          for script in "${required_scripts[@]}"; do
            script_path="$WORKSPACE_ROOT/ZenDNN_tools/scripts/ci/$script"
            if [ ! -f "$script_path" ]; then
              echo "Error: Required script $script not found at $script_path"
              ls -la "$WORKSPACE_ROOT/ZenDNN_tools/scripts/ci/"
              exit 1
            fi
          done
          
          # Make scripts executable
          chmod +x "$WORKSPACE_ROOT/ZenDNN_tools/scripts/ci/"*.sh
        shell: bash

      - name: Run CI script
        run: |
          # Print debug information
          echo "Current directory: $(pwd)"
          echo "Workspace root: $WORKSPACE_ROOT"
          echo "Home directory: $HOME"
          echo "Directory contents:"
          ls -la "$WORKSPACE_ROOT"
          ls -la "$WORKSPACE_ROOT/ZenDNN_tools/scripts/ci"
          
          # Modify CI scripts with error checking
          script_path="$WORKSPACE_ROOT/ZenDNN_tools/scripts/ci/zendnn_ci_pt_plugin_presub_build.sh"
          if [ ! -f "$script_path" ]; then
            echo "Error: Main build script not found at $script_path"
            exit 1
          fi
          
          # Backup scripts before modification
          cp "$script_path" "${script_path}.backup"
          
          # Apply modifications with error checking
          sed -i 's/sudo//g' "$script_path"
          sed -i '/mkmhub/ s/mkmhub/-v \/proj\/zendai:\/proj\/zendai mkmhub/' "$script_path"
          sed -i '/git config --global --add/ s/^/# /' "$script_path"
          sed -i 's|torch-\$NATIVE_TORCH_VERSION|torch-\$NATIVE_TORCH_VERSION-xco|g' "$script_path"
          
          # Verify script modifications
          if ! diff -u "${script_path}.backup" "$script_path"; then
            echo "Script modifications applied successfully"
          fi
          
          # Change to script directory and run
          cd "$WORKSPACE_ROOT/ZenDNN_tools/scripts/ci" || {
            echo "Error: Failed to change to script directory"
            exit 1
          }
          
          # Enable debug output and run script
          set -x
          bash ./zendnn_ci_pt_plugin_presub_build.sh
        shell: bash
        env:
          PYTHON_VERSION: ${{ env.PYTHON_VERSION }}
          BUILD_PYTHON_VERSIONS: ${{ env.PYTHON_VERSION }}
          ZENTORCH_VERSION: ${{ env.ZENTORCH_VERSION }}
          NATIVE_TORCH_VERSION: ${{ env.NATIVE_TORCH_VERSION }}
          ZENTORCH_USE_LOCAL_ZENDNN: ${{ env.ZENTORCH_USE_LOCAL_ZENDNN }}
          ZENTORCH_USE_LOCAL_BLIS: ${{ env.ZENTORCH_USE_LOCAL_BLIS }}
          UNWANTED_KEYWORDS: ${{ env.UNWANTED_KEYWORDS }}
          BLIS_TAR_BALL: ${{ env.BLIS_TAR_BALL }}
          GIT_CONFIG_GLOBAL: "${{ env.HOME }}/gitconfig"

      - name: Archive build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zentorch-artifacts
          path: |
            ${{ env.WORKSPACE_ROOT }}/ZenDNN_PyTorch_Plugin/dist/*.whl

      - name: Cleanup workspace
        if: always()
        run: |
          # Archive artifacts before cleanup
          mkdir -p /tmp/zentorch_artifacts
          cp -f ${{ env.WORKSPACE_ROOT }}/*.whl /tmp/zentorch_artifacts/ 2>/dev/null || true
          
          # Cleanup
          rm -rf "$WORKSPACE_ROOT/ZenDNN" "$WORKSPACE_ROOT/ZenDNN_tools" "$WORKSPACE_ROOT/blis" "$WORKSPACE_ROOT/$BLIS_TAR_BALL"
          rm -rf "$HOME"
        shell: bash
